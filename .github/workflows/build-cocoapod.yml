name: CocoaPods Library Build & Release

on:
  workflow_dispatch: {}

permissions:
  contents: write

jobs:
  cut_release:
    name: Release (main only)
    if: github.ref == 'refs/heads/main'
    runs-on: macos-latest
    env:
      PODSPEC: AppAmbitSdk/AppAmbitSdk.podspec

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Install CocoaPods
        run: |
          gem install cocoapods --no-document
          pod --version

      - name: Read full version from podspec
        id: ver
        shell: bash
        env:
          PODSPEC: AppAmbitSdk/AppAmbitSdk.podspec
        run: |
          set -e
          [ -f "$PODSPEC" ] || { echo "Missing $PODSPEC"; exit 1; }
          echo "Using podspec: $PODSPEC"
          FULL=$(ruby -e "v=File.read('$PODSPEC')[/s\\.version\\s*=\\s*'([^']+)'/,1]; puts(v ? v.strip : '')")
          FULL=${FULL//$'\r'/}
          [[ "$FULL" =~ ^([0-9]+\.[0-9]+\.[0-9]+)(-(alpha|beta|rc)\.[0-9]+)?$ ]] || { echo "Invalid s.version: '$FULL'"; exit 1; }
          echo "full=$FULL" >> $GITHUB_OUTPUT
          [[ "$FULL" == *-* ]] && echo "is_prerelease=true" >> $GITHUB_OUTPUT || echo "is_prerelease=false" >> $GITHUB_OUTPUT
          echo "Version (podspec): $FULL"

      - name: Extract latest CHANGELOG section
        id: changelog
        shell: bash
        run: |
          set -e
          [ -f CHANGELOG.md ] || { echo "CHANGELOG.md is missing"; exit 1; }

          # ex; "## 1.2.3" o "## Version 1.2.3"
          TITLE_LINE_NUM=$(grep -nE '^##[[:space:]]+(Version[[:space:]]+)?[0-9]+\.[0-9]+\.[0-9]+(-(?:alpha|beta|rc)\.[0-9]+)?[[:space:]]*$' CHANGELOG.md | head -n1 | cut -d: -f1)
          [ -n "$TITLE_LINE_NUM" ] || { echo "No release header found (## [Version ]X.Y.Z)"; exit 1; }

          TITLE=$(sed -n "${TITLE_LINE_NUM}p" CHANGELOG.md)
          VER_IN_TITLE=$(echo "$TITLE" | grep -Eo '[0-9]+\.[0-9]+\.[0-9]+(-(?:alpha|beta|rc)\.[0-9]+)?')
          [ -n "$VER_IN_TITLE" ] || { echo "Could not extract version from: $TITLE"; exit 1; }

          START=$((TITLE_LINE_NUM + 1))
          TOTAL_LINES=$(wc -l < CHANGELOG.md | tr -d ' ')
          NEXT_HEADER_LINE=$(tail -n +"$START" CHANGELOG.md | grep -nE '^##[[:space:]]+' | head -n1 | cut -d: -f1 || true)
          [ -z "$NEXT_HEADER_LINE" ] && END=$TOTAL_LINES || END=$((START + NEXT_HEADER_LINE - 2))
          sed -n "${START},${END}p" CHANGELOG.md > CHANGELOG_LATEST.md

          echo "title=$TITLE" >> $GITHUB_OUTPUT
          echo "ver_from_title=$VER_IN_TITLE" >> $GITHUB_OUTPUT
          echo "notes_path=CHANGELOG_LATEST.md" >> $GITHUB_OUTPUT

      - name: Enforce podspec version matches CHANGELOG
        shell: bash
        run: |
          set -e
          PS="${{ steps.ver.outputs.full }}"
          CL="${{ steps.changelog.outputs.ver_from_title }}"
          [ "$PS" = "$CL" ] || { echo "s.version ($PS) != version in CHANGELOG ($CL)."; exit 1; }
          echo "OK: s.version matches CHANGELOG."

      - name: Skip if tag already exists
        id: check_tag
        run: |
          set -e
          TAG="${{ steps.ver.outputs.full }}"
          if git ls-remote --tags origin | grep -q -E "refs/tags/${TAG}(\^\{\})?$"; then
            echo "skip=true" >> $GITHUB_OUTPUT
            echo "Tag $TAG exists. Skipping."
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi

      - name: pod lib lint (build the pod)
        run: |
          set -e
          pod lib lint ${{ env.PODSPEC }} --platforms=ios --fail-fast --verbose --allow-warnings

      - name: Tag & Push (tag current commit)
        if: steps.check_tag.outputs.skip == 'false'
        run: |
          set -e
          git tag "${{ steps.ver.outputs.full }}" "$GITHUB_SHA"
          git push origin "${{ steps.ver.outputs.full }}"

      - name: Build SDK zip (only AppAmbitSdk/)
        if: steps.check_tag.outputs.skip == 'false'
        shell: bash
        run: |
          set -e
          VER="${{ steps.ver.outputs.full }}"
          ZIP="AppAmbitSdk-${VER}.zip"
          rm -f "$ZIP"
          zip -r "$ZIP" AppAmbitSdk \
            -x "AppAmbitSdk/.git/*" "AppAmbitSdk/build/*" "AppAmbitSdk/.DS_Store" "AppAmbitSdk/**/__MACOSX/*"
          ls -lh "$ZIP"

      - name: Create GitHub Release (CHANGELOG notes)
        if: steps.check_tag.outputs.skip == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name:  ${{ steps.ver.outputs.full }}
          name:      ${{ steps.ver.outputs.full }}
          body_path: ${{ steps.changelog.outputs.notes_path }}
          prerelease: ${{ steps.ver.outputs.is_prerelease }}
          files:     AppAmbitSdk-${{ steps.ver.outputs.full }}.zip

      - name: Publish to CocoaPods
        if: steps.check_tag.outputs.skip == 'false'
        env:
          COCOAPODS_TRUNK_TOKEN: ${{ secrets.COCOAPODS_TRUNK_TOKEN }}
        run: |
          set -e
          [ -n "$COCOAPODS_TRUNK_TOKEN" ] || (echo "Missing COCOAPODS_TRUNK_TOKEN" && exit 1)
          pod trunk me || true
          pod trunk push ${{ env.PODSPEC }} --allow-warnings --verbose
